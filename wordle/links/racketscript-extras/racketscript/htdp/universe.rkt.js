import * as $rjs_core from '../../../../runtime/core.js';import * as M0 from "../../../racketscript-compiler/racketscript/private/interop.rkt.js";import * as M1 from "../../../../runtime/kernel.rkt.js";import * as M2 from "../private/jscommon.rkt.js";import * as M3 from "../../../racketscript-compiler/racketscript/interop.rkt.js";var __times_default_frames_per_second_times_ = 70;var make_big_bang = function(init_world3917, handlers3918) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}return new BigBang(init_world3917,handlers3918);};var big_bang = $rjs_core.attachProcedureArity(function(init_world3919, ...handlers39202308) {if (arguments.length<1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var handlers3920 = $rjs_core.Pair.listFromArray(handlers39202308);return make_big_bang(init_world3919,handlers3920).setup().start();});var BigBang = function(init_world3921, handlers3922) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3923 = this;this3923.world = init_world3921;this3923.interval = 1000/__times_default_frames_per_second_times_;this3923.handlers = handlers3922;this3923.__active_handlers = {};this3923.__world_change_listeners = [];this3923.__idle = true;this3923.__stopped = true;this3923.__events = [];return null;};BigBang.prototype.setup = function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3924 = this;var canvas3925 = M2.document.createElement("canvas");var ctx3926 = canvas3925.getContext("2d");canvas3925.setAttribute("tabindex",1);var let_result2309 = M1.values();canvas3925.setAttribute("style","outline: none");var let_result2310 = M1.values();this3924.__canvas = canvas3925;var let_result2311 = M1.values();this3924.__context = ctx3926;var let_result2312 = M1.values();M2.document.body.appendChild(canvas3925);var let_result2313 = M1.values();canvas3925.focus();var let_result2314 = M1.values();this3924.register_handlers();var let_result2315 = M1.values();var draw_handler3927 = this3924.__active_handlers["to-draw"];if (draw_handler3927!==false) {var if_res2316 = M1.rvoid();} else {var if_res2316 = M1.error($rjs_core.PrimitiveSymbol.make("big-bang"),$rjs_core.UString.make("to-draw handle not provided"));}if_res2316;var let_result2317 = M1.values();var img3928 = draw_handler3927.callback(this3924.world);canvas3925.width = img3928.width;canvas3925.height = img3928.height;this3924.change_world(this3924.world);return this3924;};BigBang.prototype.register_handlers = function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3929 = this;var active_handlers3930 = this3929.__active_handlers;var loop3931 = function(handlers3932) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}if (M1.pair_p(handlers3932)!==false) {var h3933 = M1.car(handlers3932)(this3929);h3933.register();active_handlers3930[h3933.name] = h3933;var if_res2318 = loop3931(M1.cdr(handlers3932));} else {var if_res2318 = M1.rvoid();}return if_res2318;};return loop3931(this3929.handlers);};BigBang.prototype.deregister_handlers = function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3934 = this;var active_handlers3935 = this3934.__active_handlers;return Object.keys(active_handlers3935).forEach(function(key3936) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var h3937 = active_handlers3935[key3936];h3937.deregister();active_handlers3935[h3937.name] = undefined;return null;});};BigBang.prototype.start = function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3938 = this;this3938.__stopped = false;this3938.queue_event({'type':"to-draw"});return this3938.process_events();};BigBang.prototype.stop = function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3939 = this;this3939.clear_event_queue();this3939.__stopped = true;this3939.__idle = true;this3939.deregister_handlers();this3939.__active_handlers = {};this3939.handlers = $rjs_core.Pair.makeList();return null;};BigBang.prototype.clear_event_queue = function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3940 = this;return this3940.__events.splice(0,this3940.__events.length);};BigBang.prototype.queue_event = function(e3941) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3942 = this;this3942.__events.push(e3941);if (this3942.__idle!==false) {var self3943 = this3942;var if_res2319 = window.requestAnimationFrame(function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}return self3943.process_events();});} else {var if_res2319 = M1.rvoid();}return if_res2319;};BigBang.prototype.change_world = function(new_world3944) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3945 = this;var listeners3946 = this3945.__world_change_listeners;var loop3947 = function(i3948) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}if (M1.__lt_(i3948,listeners3946.length)!==false) {var listener3949 = listeners3946[i3948];listener3949(new_world3944);var if_res2320 = loop3947(M1.add1(i3948));} else {var if_res2320 = M1.rvoid();}return if_res2320;};loop3947(0);this3945.world = new_world3944;return null;};BigBang.prototype.add_world_change_listener = function(cb3950) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3951 = this;return this3951.__world_change_listeners.push(cb3950);};BigBang.prototype.remove_world_change_listener = function(cb3952) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3953 = this;var index3954 = this3953.__world_change_listeners.indexOf(cb3952);return this3953.__world_change_listeners.splice(index3954,1);};BigBang.prototype.process_events = function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3955 = this;var events3956 = this3955.__events;this3955.__idle = false;var loop3957 = function(world_changed_p3958) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}if (M1.__gt_(events3956.length,0)!==false) {var evt3959 = events3956.shift();var handler3960 = this3955.__active_handlers[evt3959.type];if (M1.equal_p(evt3959.type,"raw")!==false) {var if_res2322 = evt3959.invoke(this3955.world,evt3959);} else {if (handler3960!==false) {var if_res2321 = handler3960.invoke(this3955.world,evt3959);} else {var if_res2321 = M2.console.warn($rjs_core.UString.make("ignoring unknown/unregistered event type: "),evt3959);}var if_res2322 = if_res2321;}var changed_p3961 = if_res2322;var or_part3962 = world_changed_p3958;if (or_part3962!==false) {var if_res2323 = or_part3962;} else {var if_res2323 = changed_p3961;}var if_res2326 = loop3957(if_res2323);} else {if (world_changed_p3958!==false) {var if_res2324 = M1.not(this3955.__stopped);} else {var if_res2324 = false;}if (if_res2324!==false) {this3955.queue_event({'type':"to-draw"});var if_res2325 = loop3957(false);} else {var if_res2325 = M1.rvoid();}var if_res2326 = if_res2325;}return if_res2326;};loop3957(false);this3955.__idle = true;return null;};var to_draw = function(cb3963) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return function(bb3964) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var on_tick_evt3965 = {'type':"to-draw"};return {'name':"to-draw",'register':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}return M1.rvoid();},'deregister':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}return M1.rvoid();},'callback':cb3963,'invoke':function(world3966, evt3967) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var ctx3968 = bb3964.__context;var img3969 = cb3963(bb3964.world);var height3970 = img3969.height;var width3971 = img3969.width;ctx3968.clearRect(0,0,width3971,height3970);img3969.render(ctx3968,width3971/2,height3970/2);return false;}};};};var on_tick = function(cb3972, rate3973) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}return function(bb3974) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var on_tick_evt3975 = {'type':"on-tick"};return {'name':"on-tick",'register':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3976 = this;bb3974.queue_event(on_tick_evt3975);if (rate3973!==false) {rate3973 = 1000*rate3973;var if_res2327 = null;} else {rate3973 = bb3974.interval;var if_res2327 = null;}return if_res2327;},'deregister':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3977 = this;var last_cb3978 = this3977.last_cb;if (last_cb3978!==false) {var if_res2328 = window.clearTimeout(last_cb3978);} else {var if_res2328 = M1.rvoid();}return if_res2328;},'invoke':function(world3979, _3980) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3981 = this;bb3974.change_world(cb3972(world3979));this3981.last_cb = setTimeout(function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}return bb3974.queue_event(on_tick_evt3975);},rate3973);return true;}};};};var on_mouse = function(cb3982) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return function(bb3983) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return {'name':"on-mouse",'listeners':{},'register':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3984 = this;var canvas3985 = bb3983.__canvas;var make_listener3986 = function(r_evt_name3987) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return function(evt3988) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var posn3989 = canvas_posn_δ(canvas3985,evt3988);return bb3983.queue_event({'type':"on-mouse",'evt':M3.js_string__gt_string(r_evt_name3987),'x':posn3989.x,'y':posn3989.y});};};var register_listener3990 = function(evt_name3991, r_evt_name3992) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var cb3993 = make_listener3986(r_evt_name3992);canvas3985.addEventListener(evt_name3991,cb3993);this3984.listeners[evt_name3991] = cb3993;return null;};register_listener3990("mousemove","move");register_listener3990("mousedown","button-down");register_listener3990("mouseup","button-up");register_listener3990("mouseout","leave");register_listener3990("mouseover","enter");return register_listener3990("drag","drag");},'deregister':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this3994 = this;var remove_listener3995 = function(evt_name3996) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var cb3997 = this3994.listeners[evt_name3996];return bb3983.__canvas.removeEventListener(evt_name3996,cb3997);};remove_listener3995("mousemove");remove_listener3995("mousedown");remove_listener3995("mouseup");remove_listener3995("mouseout");remove_listener3995("mouseover");return remove_listener3995("drag");},'invoke':function(world3998, evt3999) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var new_world4000 = cb3982(world3998,evt3999.x,evt3999.y,evt3999.evt);bb3983.change_world(new_world4000);return true;}};};};var on_key = function(cb4001) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return function(bb4002) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return {'name':"on-key",'register':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this4003 = this;var canvas4004 = bb4002.__canvas;this4003.listener = function(evt4005) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}evt4005.preventDefault();evt4005.stopPropagation();return bb4002.queue_event({'type':"on-key",'key':key_event__gt_key_name(evt4005)});};return canvas4004.addEventListener("keydown",this4003.listener);},'deregister':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this4006 = this;bb4002.__canvas.removeEventListener("keydown",this4006.listener);this4006.listener = undefined;return null;},'invoke':function(world4007, evt4008) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var new_world4009 = cb4001(world4007,evt4008.key);bb4002.change_world(new_world4009);return true;}};};};var on_release = function(cb4010) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return function(bb4011) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return {'name':"on-release",'register':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this4012 = this;var canvas4013 = bb4011.__canvas;this4012.listener = function(evt4014) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}evt4014.preventDefault();evt4014.stopPropagation();return bb4011.queue_event({'type':"on-release",'key':key_event__gt_key_name(evt4014)});};return canvas4013.addEventListener("keyup",this4012.listener);},'deregister':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this4015 = this;bb4011.__canvas.removeEventListener("keyup",this4015.listener);this4015.listener = undefined;return null;},'invoke':function(world4016, evt4017) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var new_world4018 = cb4010(world4016,evt4017.key);bb4011.change_world(new_world4018);return true;}};};};var stop_when4019 = function(last_world_p24020, last_picture14021) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var last_world_p4022 = last_world_p24020;if (false!==false) {var if_res2329 = false;} else {var if_res2329 = last_picture14021;}var last_picture4023 = if_res2329;return function(bb4024) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return {'name':"stop-when",'predicate':last_world_p4022,'lastpicture':last_picture4023,'register':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this4025 = this;return bb4024.add_world_change_listener(this4025.invoke);},'deregister':function() {if (arguments.length!==0) {throw $rjs_core.racketContractError("arity mismatch");} else {}var this4026 = this;return bb4024.remove_world_change_listener(this4026.invoke);},'invoke':function(w4027) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}if (last_world_p4022(w4027)!==false) {bb4024.stop();if (last_picture4023!==false) {var handler4028 = to_draw(last_picture4023)(bb4024);var if_res2330 = bb4024.queue_event({'type':"raw",'invoke':handler4028.invoke});} else {var if_res2330 = M1.rvoid();}var if_res2331 = if_res2330;} else {var if_res2331 = M1.rvoid();}return if_res2331;}};};};var cl2332 = function(last_world_p4029) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}return stop_when4019(last_world_p4029,false);};var cl2333 = function(last_world_p4030, last_picture14031) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}return stop_when4019(last_world_p4030,last_picture14031);};var stop_when = $rjs_core.attachProcedureArity(function() {var fixed_lam2334 = {'1':cl2332,'2':cl2333}[arguments.length];if (fixed_lam2334!==undefined) {return fixed_lam2334.apply(null,arguments);} else {return M1.error($rjs_core.UString.make("case-lambda: invalid case"));}},[1,2]);var key_table = {'Backspace':$rjs_core.UString.make("\b"),'Enter':$rjs_core.UString.make("\r"),'Tab':$rjs_core.UString.make("\t"),'ArrowLeft':$rjs_core.UString.make("left"),'ArrowRight':$rjs_core.UString.make("right"),'ArrowDown':$rjs_core.UString.make("down"),'ArrowUp':$rjs_core.UString.make("up"),'Shift':$rjs_core.UString.make("shift"),'Control':$rjs_core.UString.make("control"),'ControlRight':$rjs_core.UString.make("rcontrol"),'ControlLeft':$rjs_core.UString.make("control"),'ShiftRight':$rjs_core.UString.make("rshift"),'ShiftLeft':$rjs_core.UString.make("shift"),'Escape':$rjs_core.UString.make("escape"),'Home':$rjs_core.UString.make("home"),'End':$rjs_core.UString.make("end"),'Insert':$rjs_core.UString.make("insert"),'Delete':$rjs_core.UString.make("\u007F"),'Pause':$rjs_core.UString.make("pause"),'NumLock':$rjs_core.UString.make("numlock"),'F1':$rjs_core.UString.make("f1"),'F2':$rjs_core.UString.make("f2"),'F3':$rjs_core.UString.make("f3"),'F4':$rjs_core.UString.make("f4"),'F5':$rjs_core.UString.make("f5"),'F6':$rjs_core.UString.make("f6"),'F7':$rjs_core.UString.make("f7"),'F8':$rjs_core.UString.make("f8"),'F9':$rjs_core.UString.make("f9"),'F10':$rjs_core.UString.make("f10"),'F11':$rjs_core.UString.make("f11"),'F12':$rjs_core.UString.make("f12")};var key_event__gt_key_name = function(e4032) {if (arguments.length!==1) {throw $rjs_core.racketContractError("arity mismatch");} else {}var k4033 = e4032.key;var or_part4035 = k4033==="Shift";if (or_part4035!==false) {var if_res2336 = or_part4035;} else {var or_part4036 = k4033==="Control";if (or_part4036!==false) {var if_res2335 = or_part4036;} else {var if_res2335 = k4033==="Alt";}var if_res2336 = if_res2335;}if (if_res2336!==false) {var if_res2337 = e4032.code;} else {var if_res2337 = k4033;}var code4034 = if_res2337;var key_table_code4037 = key_table[code4034];if (M1.void_p(key_table_code4037)!==false) {var if_res2338 = M3.js_string__gt_string(code4034);} else {var if_res2338 = key_table_code4037;}return if_res2338;};var canvas_posn_δ = function(canvas4038, evt4039) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}var rect4040 = canvas4038.getBoundingClientRect();return {'x':evt4039.clientX-rect4040.left,'y':evt4039.clientY-rect4040.top};};var key_eq__p = function(k14041, k24042) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}return M1.equal_p(k14041,k24042);};var mouse_eq__p = function(m14043, m24044) {if (arguments.length!==2) {throw $rjs_core.racketContractError("arity mismatch");} else {}return M1.equal_p(m14043,m24044);};var __rjs_quoted__ = {};__rjs_quoted__.key_event__gt_key_name = key_event__gt_key_name;export { __rjs_quoted__,mouse_eq__p,key_eq__p,big_bang,stop_when,to_draw,on_release,on_key,on_tick,on_mouse };