import * as $rjs_core from '../../../../runtime/core.js';import * as M0 from "../../../racketscript-compiler/racketscript/private/interop.rkt.js";import * as M1 from "../../../../runtime/kernel.rkt.js";import * as M2 from "../private/jscommon.rkt.js";import * as M3 from "../../../racketscript-compiler/racketscript/interop.rkt.js";var __times_default_frames_per_second_times_ = 70;var make_big_bang = function(init_world3920, handlers3921) {return new BigBang(init_world3920,handlers3921);};var big_bang = $rjs_core.attachProcedureArity(function(init_world3922, ...handlers39232313) {var handlers3923 = $rjs_core.Pair.listFromArray(handlers39232313);return make_big_bang(init_world3922,handlers3923).setup().start();});var BigBang = function(init_world3924, handlers3925) {var this3926 = this;this3926.world = init_world3924;this3926.interval = 1000/__times_default_frames_per_second_times_;this3926.handlers = handlers3925;this3926.__active_handlers = {};this3926.__world_change_listeners = [];this3926.__idle = true;this3926.__stopped = true;this3926.__events = [];return null;};BigBang.prototype.setup = function() {var this3927 = this;var canvas3928 = M2.document.createElement("canvas");var ctx3929 = canvas3928.getContext("2d");canvas3928.setAttribute("tabindex",1);var let_result2314 = M1.values();canvas3928.setAttribute("style","outline: none");var let_result2315 = M1.values();this3927.__canvas = canvas3928;var let_result2316 = M1.values();this3927.__context = ctx3929;var let_result2317 = M1.values();M2.document.body.appendChild(canvas3928);var let_result2318 = M1.values();canvas3928.focus();var let_result2319 = M1.values();this3927.register_handlers();var let_result2320 = M1.values();var draw_handler3930 = this3927.__active_handlers["to-draw"];if (draw_handler3930!==false) {var if_res2321 = M1.rvoid();} else {var if_res2321 = M1.error($rjs_core.PrimitiveSymbol.make("big-bang"),$rjs_core.UString.make("to-draw handle not provided"));}if_res2321;var let_result2322 = M1.values();var img3931 = draw_handler3930.callback(this3927.world);canvas3928.width = img3931.width;canvas3928.height = img3931.height;this3927.change_world(this3927.world);return this3927;};BigBang.prototype.register_handlers = function() {var this3932 = this;var active_handlers3933 = this3932.__active_handlers;var loop3934 = function(handlers3935) {if (M1.pair_p(handlers3935)!==false) {var h3936 = M1.car(handlers3935)(this3932);h3936.register();active_handlers3933[h3936.name] = h3936;var if_res2323 = loop3934(M1.cdr(handlers3935));} else {var if_res2323 = M1.rvoid();}return if_res2323;};return loop3934(this3932.handlers);};BigBang.prototype.deregister_handlers = function() {var this3937 = this;var active_handlers3938 = this3937.__active_handlers;return Object.keys(active_handlers3938).forEach(function(key3939) {var h3940 = active_handlers3938[key3939];h3940.deregister();active_handlers3938[h3940.name] = undefined;return null;});};BigBang.prototype.start = function() {var this3941 = this;this3941.__stopped = false;this3941.queue_event({'type':"to-draw"});return this3941.process_events();};BigBang.prototype.stop = function() {var this3942 = this;this3942.clear_event_queue();this3942.__stopped = true;this3942.__idle = true;this3942.deregister_handlers();this3942.__active_handlers = {};this3942.handlers = $rjs_core.Pair.makeList();return null;};BigBang.prototype.clear_event_queue = function() {var this3943 = this;return this3943.__events.splice(0,this3943.__events.length);};BigBang.prototype.queue_event = function(e3944) {var this3945 = this;this3945.__events.push(e3944);if (this3945.__idle!==false) {var self3946 = this3945;var if_res2324 = window.requestAnimationFrame(function() {return self3946.process_events();});} else {var if_res2324 = M1.rvoid();}return if_res2324;};BigBang.prototype.change_world = function(new_world3947) {var this3948 = this;var listeners3949 = this3948.__world_change_listeners;var loop3950 = function(i3951) {if (M1.__lt_(i3951,listeners3949.length)!==false) {var listener3952 = listeners3949[i3951];listener3952(new_world3947);var if_res2325 = loop3950(M1.add1(i3951));} else {var if_res2325 = M1.rvoid();}return if_res2325;};loop3950(0);this3948.world = new_world3947;return null;};BigBang.prototype.add_world_change_listener = function(cb3953) {var this3954 = this;return this3954.__world_change_listeners.push(cb3953);};BigBang.prototype.remove_world_change_listener = function(cb3955) {var this3956 = this;var index3957 = this3956.__world_change_listeners.indexOf(cb3955);return this3956.__world_change_listeners.splice(index3957,1);};BigBang.prototype.process_events = function() {var this3958 = this;var events3959 = this3958.__events;this3958.__idle = false;var loop3960 = function(world_changed_p3961) {if (M1.__gt_(events3959.length,0)!==false) {var evt3962 = events3959.shift();var handler3963 = this3958.__active_handlers[evt3962.type];if (M1.equal_p(evt3962.type,"raw")!==false) {var if_res2327 = evt3962.invoke(this3958.world,evt3962);} else {if (handler3963!==false) {var if_res2326 = handler3963.invoke(this3958.world,evt3962);} else {var if_res2326 = M2.console.warn($rjs_core.UString.make("ignoring unknown/unregistered event type: "),evt3962);}var if_res2327 = if_res2326;}var changed_p3964 = if_res2327;var or_part3965 = world_changed_p3961;if (or_part3965!==false) {var if_res2328 = or_part3965;} else {var if_res2328 = changed_p3964;}var if_res2331 = loop3960(if_res2328);} else {if (world_changed_p3961!==false) {var if_res2329 = M1.not(this3958.__stopped);} else {var if_res2329 = false;}if (if_res2329!==false) {this3958.queue_event({'type':"to-draw"});var if_res2330 = loop3960(false);} else {var if_res2330 = M1.rvoid();}var if_res2331 = if_res2330;}return if_res2331;};loop3960(false);this3958.__idle = true;return null;};var to_draw = function(cb3966) {return function(bb3967) {var on_tick_evt3968 = {'type':"to-draw"};return {'name':"to-draw",'register':function() {return M1.rvoid();},'deregister':function() {return M1.rvoid();},'callback':cb3966,'invoke':function(world3969, evt3970) {var ctx3971 = bb3967.__context;var img3972 = cb3966(bb3967.world);var height3973 = img3972.height;var width3974 = img3972.width;ctx3971.clearRect(0,0,width3974,height3973);img3972.render(ctx3971,width3974/2,height3973/2);return false;}};};};var on_tick = function(cb3975, rate3976) {return function(bb3977) {var on_tick_evt3978 = {'type':"on-tick"};return {'name':"on-tick",'register':function() {var this3979 = this;bb3977.queue_event(on_tick_evt3978);if (rate3976!==false) {rate3976 = 1000*rate3976;var if_res2332 = null;} else {rate3976 = bb3977.interval;var if_res2332 = null;}return if_res2332;},'deregister':function() {var this3980 = this;var last_cb3981 = this3980.last_cb;if (last_cb3981!==false) {var if_res2333 = window.clearTimeout(last_cb3981);} else {var if_res2333 = M1.rvoid();}return if_res2333;},'invoke':function(world3982, _3983) {var this3984 = this;bb3977.change_world(cb3975(world3982));this3984.last_cb = setTimeout(function() {return bb3977.queue_event(on_tick_evt3978);},rate3976);return true;}};};};var on_mouse = function(cb3985) {return function(bb3986) {return {'name':"on-mouse",'listeners':{},'register':function() {var this3987 = this;var canvas3988 = bb3986.__canvas;var make_listener3989 = function(r_evt_name3990) {return function(evt3991) {var posn3992 = canvas_posn_δ(canvas3988,evt3991);return bb3986.queue_event({'type':"on-mouse",'evt':M3.js_string__gt_string(r_evt_name3990),'x':posn3992.x,'y':posn3992.y});};};var register_listener3993 = function(evt_name3994, r_evt_name3995) {var cb3996 = make_listener3989(r_evt_name3995);canvas3988.addEventListener(evt_name3994,cb3996);this3987.listeners[evt_name3994] = cb3996;return null;};register_listener3993("mousemove","move");register_listener3993("mousedown","button-down");register_listener3993("mouseup","button-up");register_listener3993("mouseout","leave");register_listener3993("mouseover","enter");return register_listener3993("drag","drag");},'deregister':function() {var this3997 = this;var remove_listener3998 = function(evt_name3999) {var cb4000 = this3997.listeners[evt_name3999];return bb3986.__canvas.removeEventListener(evt_name3999,cb4000);};remove_listener3998("mousemove");remove_listener3998("mousedown");remove_listener3998("mouseup");remove_listener3998("mouseout");remove_listener3998("mouseover");return remove_listener3998("drag");},'invoke':function(world4001, evt4002) {var new_world4003 = cb3985(world4001,evt4002.x,evt4002.y,evt4002.evt);bb3986.change_world(new_world4003);return true;}};};};var on_key = function(cb4004) {return function(bb4005) {return {'name':"on-key",'register':function() {var this4006 = this;var canvas4007 = bb4005.__canvas;this4006.listener = function(evt4008) {evt4008.preventDefault();evt4008.stopPropagation();return bb4005.queue_event({'type':"on-key",'key':key_event__gt_key_name(evt4008)});};return canvas4007.addEventListener("keydown",this4006.listener);},'deregister':function() {var this4009 = this;bb4005.__canvas.removeEventListener("keydown",this4009.listener);this4009.listener = undefined;return null;},'invoke':function(world4010, evt4011) {var new_world4012 = cb4004(world4010,evt4011.key);bb4005.change_world(new_world4012);return true;}};};};var on_release = function(cb4013) {return function(bb4014) {return {'name':"on-release",'register':function() {var this4015 = this;var canvas4016 = bb4014.__canvas;this4015.listener = function(evt4017) {evt4017.preventDefault();evt4017.stopPropagation();return bb4014.queue_event({'type':"on-release",'key':key_event__gt_key_name(evt4017)});};return canvas4016.addEventListener("keyup",this4015.listener);},'deregister':function() {var this4018 = this;bb4014.__canvas.removeEventListener("keyup",this4018.listener);this4018.listener = undefined;return null;},'invoke':function(world4019, evt4020) {var new_world4021 = cb4013(world4019,evt4020.key);bb4014.change_world(new_world4021);return true;}};};};var stop_when4022 = function(last_world_p24023, last_picture14024) {var last_world_p4025 = last_world_p24023;if (false!==false) {var if_res2334 = false;} else {var if_res2334 = last_picture14024;}var last_picture4026 = if_res2334;return function(bb4027) {return {'name':"stop-when",'predicate':last_world_p4025,'lastpicture':last_picture4026,'register':function() {var this4028 = this;return bb4027.add_world_change_listener(this4028.invoke);},'deregister':function() {var this4029 = this;return bb4027.remove_world_change_listener(this4029.invoke);},'invoke':function(w4030) {if (last_world_p4025(w4030)!==false) {bb4027.stop();if (last_picture4026!==false) {var handler4031 = to_draw(last_picture4026)(bb4027);var if_res2335 = bb4027.queue_event({'type':"raw",'invoke':handler4031.invoke});} else {var if_res2335 = M1.rvoid();}var if_res2336 = if_res2335;} else {var if_res2336 = M1.rvoid();}return if_res2336;}};};};var cl2337 = function(last_world_p4032) {return stop_when4022(last_world_p4032,false);};var cl2338 = function(last_world_p4033, last_picture14034) {return stop_when4022(last_world_p4033,last_picture14034);};var stop_when = $rjs_core.attachProcedureArity(function() {var fixed_lam2339 = {'1':cl2337,'2':cl2338}[arguments.length];if (fixed_lam2339!==undefined) {return fixed_lam2339.apply(null,arguments);} else {return M1.error($rjs_core.UString.make("case-lambda: invalid case"));}},[1,2]);var key_table = {'Backspace':$rjs_core.UString.make("\b"),'Enter':$rjs_core.UString.make("\r"),'Tab':$rjs_core.UString.make("\t"),'ArrowLeft':$rjs_core.UString.make("left"),'ArrowRight':$rjs_core.UString.make("right"),'ArrowDown':$rjs_core.UString.make("down"),'ArrowUp':$rjs_core.UString.make("up"),'Shift':$rjs_core.UString.make("shift"),'Control':$rjs_core.UString.make("control"),'ControlRight':$rjs_core.UString.make("rcontrol"),'ControlLeft':$rjs_core.UString.make("control"),'ShiftRight':$rjs_core.UString.make("rshift"),'ShiftLeft':$rjs_core.UString.make("shift"),'Escape':$rjs_core.UString.make("escape"),'Home':$rjs_core.UString.make("home"),'End':$rjs_core.UString.make("end"),'Insert':$rjs_core.UString.make("insert"),'Delete':$rjs_core.UString.make("\u007F"),'Pause':$rjs_core.UString.make("pause"),'NumLock':$rjs_core.UString.make("numlock"),'F1':$rjs_core.UString.make("f1"),'F2':$rjs_core.UString.make("f2"),'F3':$rjs_core.UString.make("f3"),'F4':$rjs_core.UString.make("f4"),'F5':$rjs_core.UString.make("f5"),'F6':$rjs_core.UString.make("f6"),'F7':$rjs_core.UString.make("f7"),'F8':$rjs_core.UString.make("f8"),'F9':$rjs_core.UString.make("f9"),'F10':$rjs_core.UString.make("f10"),'F11':$rjs_core.UString.make("f11"),'F12':$rjs_core.UString.make("f12")};var key_event__gt_key_name = function(e4035) {var k4036 = e4035.key;var or_part4038 = k4036==="Shift";if (or_part4038!==false) {var if_res2341 = or_part4038;} else {var or_part4039 = k4036==="Control";if (or_part4039!==false) {var if_res2340 = or_part4039;} else {var if_res2340 = k4036==="Alt";}var if_res2341 = if_res2340;}if (if_res2341!==false) {var if_res2342 = e4035.code;} else {var if_res2342 = k4036;}var code4037 = if_res2342;var key_table_code4040 = key_table[code4037];if (M1.void_p(key_table_code4040)!==false) {var if_res2343 = M3.js_string__gt_string(code4037);} else {var if_res2343 = key_table_code4040;}return if_res2343;};var canvas_posn_δ = function(canvas4041, evt4042) {var rect4043 = canvas4041.getBoundingClientRect();return {'x':evt4042.clientX-rect4043.left,'y':evt4042.clientY-rect4043.top};};var key_eq__p = function(k14044, k24045) {return M1.equal_p(k14044,k24045);};var mouse_eq__p = function(m14046, m24047) {return M1.equal_p(m14046,m24047);};var __rjs_quoted__ = {};__rjs_quoted__.key_event__gt_key_name = key_event__gt_key_name;export { __rjs_quoted__,mouse_eq__p,key_eq__p,big_bang,stop_when,to_draw,on_release,on_key,on_tick,on_mouse };